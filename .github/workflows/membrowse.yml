name: ESP32 LVGL + MemBrowse

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo with submodules
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # 2️⃣ Setup Python for MemBrowse
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # 3️⃣ Setup ESP-IDF (v5.1 recommended for esp_timer)
      - name: Setup ESP-IDF
        uses: espressif/esp-idf-action@v1
        with:
          version: v5.1  # use v4.4 if you want older stable

      # 4️⃣ Build firmware
      - name: Build ESP32 firmware
        shell: bash
        run: |
          # Source ESP-IDF so idf.py is in PATH
          source $IDF_PATH/export.sh
          
          # Verify ESP-IDF is available
          echo "Using ESP-IDF at: $IDF_PATH"
          which idf.py
          idf.py --version

          # Build the firmware
          idf.py build

      # 5️⃣ Verify ELF file exists
      - name: Verify ELF
        run: |
          test -f build/lv_port_esp32.elf || (echo "ELF not found!" && exit 1)
          echo "ELF successfully built!"

      # 6️⃣ Generate MemBrowse report
      - name: MemBrowse report
        run: |
          pip install --no-cache-dir membrowse
          membrowse report build/lv_port_esp32.elf sdkconfig --json > membrowse.json

      # 7️⃣ Upload build artifacts
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: esp32-build
          path: |
            build/lv_port_esp32.elf
            membrowse.json
